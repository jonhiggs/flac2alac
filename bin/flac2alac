#!/bin/bash

# flac2alac By Arlindo \"Nighto\" Pereira <nighto@nighto.net>
# (C) 2010,2013. Licensed on GPLv3"

# modified by jeffrey paul <sneak@datavibe.net>
# further modified by jon higgs <jhiggs@eml.cc>

# inspiration from http://ca.ubuntuforums.org/member.php?u=6176 (MetalMusicAddict)
# script at http://ca.ubuntuforums.org/showthread.php?t=889700&page=2

function usage() {
  if [ $# -lt 1 ]; then
    echo "usage: $0 [-d] <file.flac> [file2.flac] [...]" > /dev/stderr
    exit 1
  fi
}

source `dirname $0`/../lib/convert
echo `dirname $0`/../lib/convert
exit 1


DELETE_WHEN_DONE="false"

for filename in "$@"; do
	[ "$filename" == "-d" ] && DELETE_WHEN_DONE="true"

	if flac_valid "$filename"; then
    album=`get_tag_from_flac $filename album`
    album_artist=`get_tag_from_flac $filename album_artist`
    art_file=`get_tag_from_flac $filename art_file`
    artist=`get_tag_from_flac $filename artist`
    composer=`get_tag_from_flac $filename composer`
    date=`get_tag_from_flac $filename date`
    description=`get_tag_from_flac $filename description`
    disc_number=`get_tag_from_flac $filename disc_number`
    disc_total=`get_tag_from_flac $filename disc_total`
    genre=`get_tag_from_flac $filename genre`
    title=`get_tag_from_flac $filename title`
    track_number=`get_tag_from_flac $filename track_number`
    track_total=`get_tag_from_flac $filename track_total`
    # get the art file from the flac file

    alac_file=`flac2alac "$filename"`

    add_art_to_alac "$alac_file" "album=$album"
    add_art_to_alac "$alac_file" "album_artist=$album_artist"
    add_art_to_alac "$alac_file" "art_file=$art_file"
    add_art_to_alac "$alac_file" "artist=$artist"
    add_art_to_alac "$alac_file" "composer=$composer"
    add_art_to_alac "$alac_file" "date=$date"
    add_art_to_alac "$alac_file" "description=$description"
    add_art_to_alac "$alac_file" "disc_number=$disc_number"
    add_art_to_alac "$alac_file" "disc_total=$disc_total"
    add_art_to_alac "$alac_file" "genre=$genre"
    add_art_to_alac "$alac_file" "title=$title"
    add_art_to_alac "$alac_file" "track_number=$track_number"
    add_art_to_alac "$alac_file" "track_total=$track_total"
    # add the art to the alac file

    mv $alac_file $filename.m4a
    rename 's/flac.m4a/m4a' $filename
    
    $DELETE_WHEN_DONE && rm $filename
  fi
done

__rmtemp
exit 0
